<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="Bookmarks" script:language="StarBasic" script:moduleType="normal">Sub setFootnotesNumbering
	Dim enum1Element As Object
	Dim enum1 As Object
	Dim enum2 As Object
	Dim thisPortion As Object
	Dim curNum As Integer
	Dim footnoteText As Object
	Dim label As String
	Dim labelNum As Integer
	Dim i As Integer
	Dim cell As Object
	Dim cellEnum As Object
	Dim cellEnum2 As Object
	curNum = 1
	enum1 = ThisComponent.Text.createEnumeration
	While enum1.hasMoreElements
		enum1Element = enum1.nextElement
		If enum1Element.supportsService("com.sun.star.text.Paragraph") Then
			If enum1Element.OutlineLevel = 2 Then
				curNum = 1 
			EndIf
			enum2 = enum1Element.createEnumeration
			While enum2.hasMoreElements
				thisPortion = enum2.nextElement
				If thisPortion.TextPortionType = "Footnote" Then
					footnoteText = thisPortion.Footnote
					label = footnoteText.getLabel
					If label = "" Then 
						footnoteText.setLabel(CStr(curNum))
						curNum = curNum + 1
					Else
						labelNum = CInt(label)
						If labelNum &gt; 0 Then
							footnoteText.setLabel(CStr(curNum))
							curNum = curNum + 1
						EndIf
					EndIf
				EndIf
			Wend
		ElseIf enum1Element.supportsService("com.sun.star.text.TextTable") Then
			cellNames = enum1Element.cellNames
			For i = LBound(cellNames) To Ubound(cellNames)
				cell = enum1Element.getCellByName(cellNames(i))
				cellEnum = cell.getText().createEnumeration()
				While cellEnum.hasMoreElements 
					cellEnumElement = cellEnum.nextElement
					If cellEnumElement.supportsService("com.sun.star.text.Paragraph") Then
						If cellEnumElement.OutlineLevel = 2 Then
						curNum = 1 
						EndIf
						cellEnum2 = cellEnumElement.createEnumeration
						While cellEnum2.hasMoreElements
							thisPortion = cellEnum2.nextElement
							If thisPortion.TextPortionType = "Footnote" Then
								footnoteText = thisPortion.Footnote
								label = footnoteText.getLabel
								If label = "" Then 
									footnoteText.setLabel(CStr(curNum))
									curNum = curNum + 1
								Else
									labelNum = CInt(label)
									If labelNum &gt; 0 Then
										footnoteText.setLabel(CStr(curNum))
										curNum = curNum + 1
									EndIf
								EndIf
							EndIf
						Wend
					EndIf
				Wend
		    Next i
		EndIf
	Wend 
End Sub
Sub convertBookmarksToFootnotes()
	Dim bookmarks as Object
	Dim bookmarkName as String
	Dim strStart As Integer
	Dim linkPrefix As String 
	Dim backLinkSuffix As String
	Dim backwardLink As String
	Dim forwardLink As String
	Dim forward As Object
	Dim backward As Object
	linkPrefix = "footnote-"
	backLinkSuffix = "-backlink"

	bookmarkName = ThisComponent.Links.ElementNames(6)
	bookmarks = ThisComponent.Links.getByName(bookmarkName)
'	Mri bookmarks
	bookmarkNames = bookmarks.getElementNames()
	For i = LBound(bookmarkNames) To Ubound(bookmarkNames)
		bookmarkName = bookmarkNames(i)
		If InStr(bookmarkName, linkPrefix) = 1 Then
			forwardLink = ""
			backwardLink = ""
			If InStr(bookmarkName, backLinkSuffix) &gt; 0 Then
				forwardLink = Left(bookmarkName,Len(bookmarkName) - Len(backLinkSuffix))
				backwardLink = bookmarkName
			Else
				forwardLink = bookmarkName 
				backwardLink = bookmarkName + backLinkSuffix
			EndIf
			convertLinkToFootnote(forwardLink,backwardLink)
		EndIf
			
	Next i
	
	NotesCleanStyle
	
End Sub

Sub convertLinkToFootnote(forwardLink,backwardLink)
	Dim bookMarkName As String
	bookmarkName = ThisComponent.Links.ElementNames(6)
	Dim bookmarks As Object
	bookmarks = ThisComponent.Links.getByName(bookmarkName)
	Dim forward As Object
	Dim backward As Object
	Dim oViewCursor As Object
	Dim footNoteSign As String
	oViewCursor = ThisComponent.CurrentController.getViewCursor()
	Dim oTextCursor As Object
	'oViewCursor = 
	If NOT bookmarks.hasByName(forwardLink) OR NOT bookmarks.hasByName(backwardLink) Then
		exit sub
		'If msgbox( "NO SuCH LINK", 36 ) = 6 Then Stop
	EndIf	
	forward = bookmarks.getByName(forwardLink)
	backward = bookmarks.getByName(backwardLink)
	oViewCursor.goToRange(forward.Anchor,false)
	footNoteSign = oViewCursor.getString()
	backspace
	backspace
	SendRM
	oTextCursor = oViewCursor.Text.createTextCursorByRange(oViewCursor)
	oTextCursor.gotoEndOfParagraph(false)
	oTextCursor.gotoStartOfParagraph(true)
	oViewCursor.goToRange(oTextCursor,true)
	unoCut()
	SendRM
	oViewCursor.goToRange(backward.Anchor,false)
	backspace
	createFootnote
	unoPaste()
	oViewCursor.getText.setLabel(footNoteSign)
	forward.dispose()
	backward.dispose()

End sub


sub unoCut
rem ----------------------------------------------------------------------
rem define variables
dim document   as object
dim dispatcher as object
rem ----------------------------------------------------------------------
rem get access to the document
document   = ThisComponent.CurrentController.Frame
dispatcher = createUnoService("com.sun.star.frame.DispatchHelper")

rem ----------------------------------------------------------------------
dispatcher.executeDispatch(document, ".uno:Cut", "", 0, Array())

end sub

sub unoPaste
rem ----------------------------------------------------------------------
rem define variables
dim document   as object
dim dispatcher as object
rem ----------------------------------------------------------------------
rem get access to the document
document   = ThisComponent.CurrentController.Frame
dispatcher = createUnoService("com.sun.star.frame.DispatchHelper")

rem ----------------------------------------------------------------------
dispatcher.executeDispatch(document, ".uno:Paste", "", 0, Array())

end sub


sub createFootnote
rem ----------------------------------------------------------------------
rem define variables
dim document   as object
dim dispatcher as object
rem ----------------------------------------------------------------------
rem get access to the document
document   = ThisComponent.CurrentController.Frame
dispatcher = createUnoService("com.sun.star.frame.DispatchHelper")

rem ----------------------------------------------------------------------
dispatcher.executeDispatch(document, ".uno:InsertFootnote", "", 0, Array())


end Sub


Sub disposeAllLinks
'	Globalscope.BasicLibraries.LoadLibrary( "MRILib" )
	Dim oPar As Object
	Dim enum1 As Object
	Dim thisPortion As Object
	enum1 = ThisComponent.Text.createEnumeration
	While enum1.hasMoreElements
		oPar = enum1.nextElement
	'	Mri oPar
		If oPar.supportsService("com.sun.star.text.Paragraph") Then
			enum2 = oPar.createEnumeration
			While enum2.hasMoreElements
				thisPortion = enum2.nextElement
				thisPortion.HyperlinkTarget = ""
				thisPortion.HyperLinkURL = ""
			Wend
		End If
	Wend 
End Sub

Sub disposeAllBookmarks()
	Dim bookmarks As Object
	bookmarks = ThisComponent.Links.getByName("Закладки")
	While bookmarks.hasElements()
		bookmark = bookmarks.getByName(bookmarks.ElementNames(0))
		bookmark.dispose()
	Wend
End Sub

</script:module>
