<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="pageHelpers" script:language="StarBasic" script:moduleType="normal">Sub removeEmptyPage

	Dim oViewCursor As Object
	oViewCursor = ThisComponent.CurrentController.getViewCursor()
	oViewCursor.jumpToStartOfPage()
	Dim oTextCursor As Object
	oTextCursor = oViewCursor.Text.createTextCursorByRange(oViewCursor)
	oViewCursor.jumpToEndOfPage()
	oViewCursor.goToRange(oTextCursor,true)
	
	If oViewCursor.isCollapsed Then
		oViewCursor.goLeft(1,false)
		SendRM()
	Else
		oViewCursor.jumpToEndOfPage()
		
	End If
	oViewCursor.collapseToEnd()

End Sub
Function findFirstPageWithStyle(pageStyleName)
	Dim oViewCursor As Object
	Dim curPage As String
	Dim prevPage As String
	oViewCursor = ThisComponent.CurrentController.getViewCursor()
	oViewCursor.jumpToFirstPage()
	curPage = oViewCursor.getPage()
	
	Do While curPage &lt;&gt; prevPage
		curStyleName = oViewCursor.PageStyleName
		If pageStyleName = curStyleName Then
			findFirstPageWithStyle = curPage
			Exit Function
		EndIf
		prevPage = curPage
		oViewCursor.jumpToNextPage()
		curPage = oViewCursor.getPage()
	Loop 
	findFirstPageWithStyle = -1
End Function



Sub createPageStyleByExample(newName)
	dim document   as object
	dim dispatcher as object
	document   = ThisComponent.CurrentController.Frame
	dispatcher = createUnoService("com.sun.star.frame.DispatchHelper")
	dim args1(1) as new com.sun.star.beans.PropertyValue
	args1(0).Name = "Param"
	args1(0).Value = newName
	args1(1).Name = "Family"
	args1(1).Value = 8
	dispatcher.executeDispatch(document, ".uno:StyleNewByExample", "", 0, args1())
end Sub

Sub updateLastPageFields
	Dim enum1Element As Object
	Dim enum1 As Object
	Dim enum2 As Object
	Dim thisPortion As Object
	Dim footnoteText As Object
	Dim label As String
	Dim labelNum As Integer
	Dim i As Integer
	Dim cell As Object
	Dim cellEnum As Object
	Dim cellEnum2 As Object
	Dim pageStyleName As String
	Dim articleName As String
	Dim articleNamePrefix As String	
	Dim articleNamePostfix As String
	Dim strPos As Integer	
	Dim articleNum As Integer
	Dim curNum As Integer
	Dim pageNum As Integer
	Dim textCursor As Object
	Dim lastPages%( 100 )
	For i = 0 to 100
      lastPages%(i) = 0
	next i
	articleNum = 0
	articleName = "0"
	articleNamePrefix = "Статья "
	articleNamePostfix = " "
	Dim statusIndicator as Object
	statusIndicator = ThisComponent.getCurrentController.statusIndicator
	statusIndicator.Start("Производится обновление полей последних номеров страниц, подождите",30)
	enum1 = ThisComponent.Text.createEnumeration
	While enum1.hasMoreElements

		enum1Element = enum1.nextElement
		If enum1Element.supportsService("com.sun.star.text.Paragraph") OR enum1Element.supportsService("com.sun.star.text.TextTable") Then

			pageStyleName = getPageStyleNameFromEnum(enum1Element)

			If Len(pageStyleName) &gt; 0 Then
				strPos = InStr(pageStyleName, articleNamePrefix)
				If strPos &lt;&gt; 0 Then
					articleName = Right(pageStyleName, Len(pageStyleName)-Len(articleNamePrefix))
					strPos = InStr(articleName, articleNamePostfix)
					If strPos &gt; 0 Then
						articleName = Left(articleName,strPos)
					EndIf
					'If first article reached
					If articleNum = 0 Then
						articleNum = CInt(Trim(articleName))
					EndIf				
				Else
					articleName = "0"
				EndIf
				
				If articleNum &gt; 0 Then
					curNum = CInt(Trim(articleName))
					If articleNum &lt;&gt; curNum Then
						textCursor = enum1Element.getText.createTextCursorByRange(enum1Element.Start)
						pageNum = getPageNumber(textCursor)
						lastPages(articleNum) = CInt(pageNum) - 1
						articleNum = curNum						
					EndIf
				EndIf
			EndIf
			
		EndIf
	Wend 
	For i = 0 to 100
      If lastPages%(i) &lt;&gt; 0 Then
      	updateUserField("article" + i + "LastPage",lastPages%(i))
      EndIf
	next i
	statusIndicator.end()
End Sub

Function getPageStyleNameFromEnum(enumElement)
	If enumElement.pageDescName = "" AND Not IsEmpty(enumElement.getPropertyValue("PageStyleName")) Then
		getPageStyleNameFromEnum = enumElement.pageStyleName
	Else 
		getPageStyleNameFromEnum = enumElement.pageDescName
	EndIf
End Function




Function getPageNumber(cursor)
  Dim oField  'Field to insert
  oTextCursor =  cursor.Text.createTextCursorByRange(cursor.Start)
  oField = ThisComponent.createInstance("com.sun.star.text.textfield.PageNumber")
  oField.NumberingType = 4
  oField.SubType = com.sun.star.text.PageNumberType.CURRENT
  oTextCursor.Text.insertTextContent(oTextCursor, oField, False)
  getPageNumber = oField.getPresentation(false)
  oTextCursor.Text.removeTextContent(oField)
End Function 

Sub testPageNum
'  oViewCursor = ThisComponent.CurrentController.getViewCursor()
  updateUserField("fieldName","fieldValueXXX")
End Sub

Function updateUserField(fieldName,fieldValue)
  Dim oFieldMaster As Object
  Dim oMasters As Object
  oMasters = ThisComponent.getTextFieldMasters()
  If oMasters.hasByName("com.sun.star.text.FieldMaster.User" &amp; "." &amp; fieldName) Then
  	oFieldMaster = oMasters.getByName("com.sun.star.text.FieldMaster.User" &amp; "." &amp; fieldName)
  	oFieldMaster.Content = fieldValue
  EndIf
End Function 

Function insertUserField(cursor,fieldName,fieldValue)
  Dim oField  As Object 'Field to insert
  Dim oFieldMaster As Object
  Dim oMasters As Object
  oTextCursor =  cursor.Text.createTextCursorByRange(cursor.Start)
  oField = ThisComponent.createInstance("com.sun.star.text.textfield.User")
  oMasters = ThisComponent.getTextFieldMasters()
  If oMasters.hasByName("com.sun.star.text.FieldMaster.User" &amp; "." &amp; fieldName) Then
  	oFieldMaster = oMasters.getByName("com.sun.star.text.FieldMaster.User" &amp; "." &amp; fieldName)
	oFieldMaster.Name = fieldName
	oFieldMaster.Content = fieldValue
  Else 
	oFieldMaster = ThisComponent.createInstance("com.sun.star.text.FieldMaster.User")
	oFieldMaster.Name = fieldName
	oFieldMaster.Content = fieldValue
  EndIf
  oField.attachTextFieldMaster(oFieldMaster)
  oTextCursor.Text.insertTextContent(oTextCursor, oField, False)
End Function 


</script:module>
